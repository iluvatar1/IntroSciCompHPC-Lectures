
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>10. Profiling &#8212; Introduction to Scientific and High Performance Computing</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/styles.css?v=03b9d5b1" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '10-profiling/10-profiling';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="11. Numerical libraries in Matrix Problems" href="../11-matrices-numericallibs/11-matrices-numericallibs.html" />
    <link rel="prev" title="9. Optimization" href="../10-optimization/10-optimization.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Nanoscience_High-Performance_Computing_Facility.jpg/1600px-Nanoscience_High-Performance_Computing_Facility.jpg" class="logo__image only-light" alt="Introduction to Scientific and High Performance Computing - Home"/>
    <script>document.write(`<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Nanoscience_High-Performance_Computing_Facility.jpg/1600px-Nanoscience_High-Performance_Computing_Facility.jpg" class="logo__image only-dark" alt="Introduction to Scientific and High Performance Computing - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    Introduction to Scientific and High Performance Computing
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to scientific computing and programming tools</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01-Introduction/01-Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01-Introduction/CPPReview.html">2. Very short review for c++ programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02-errorsfpnumbers/ErrorsFPNumbers.html">3. Errors in Floating Point Numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04-Makefiles/04-Makefiles.html">4. Makefiles as automation tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06-stdlib-randomnumbers/06-stdlib-randomnumbers.html">5. Standard library of functions: math functions, containers and random numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07-Install-Programs-From-Source/07-Install-Programs-From-Source.html">6. Using software in a hpc environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09-Debugging/09-Debugging.html">7. Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09-UnitTest/09-UnitTesting.html">8. Unit Testing : Making sure your bugs don’t come back</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">High Performance Computing and Parallel Programming</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../10-optimization/10-optimization.html">9. Optimization</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">10. Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11-matrices-numericallibs/11-matrices-numericallibs.html">11. Numerical libraries in Matrix Problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11-matrix-performance/11-matrix-performance.html">12. Performance measurement for some matrix ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../12-IntroHPC/ParallelProgramming-Intro.html">13. Introduction to High Performance Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../13-OpenMP/OpenMP-Intro.html">14. Introduction to OpenMp (Shared memory)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../15-Intro-Slurm/Slurm.html">15. HPC resource manager: Slurm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../14-MPI/MPI-Intro.html">16. Introduction to MPI (distributed memory)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../15-Intro-Cuda/cuda.html">17. Ref</a></li>
<li class="toctree-l1"><a class="reference internal" href="../16-Extra/ExtraToolsForDevelopment.html">18. Some extra tools for development</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../A-01-Git/VersionControlGit.html">19. Git introduction</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/iluvatar1/IntroSciCompHPC-Lectures/master?urlpath=lab/tree/10-profiling/10-profiling.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/iluvatar1/IntroSciCompHPC-Lectures/blob/master/github/iluvatar1/IntroSciCompHPC-Lectures/blob/master/10-profiling/10-profiling.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/iluvatar1/IntroSciCompHPC-Lectures" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/iluvatar1/IntroSciCompHPC-Lectures/issues/new?title=Issue%20on%20page%20%2F10-profiling/10-profiling.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/10-profiling/10-profiling.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Profiling</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-profile">10.1. Why profile?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measuring-the-whole-running-time">10.2. Measuring the whole running time</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measuring-elapsed-time">10.3. Measuring elapsed time</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">10.3.1. Exercise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">10.3.2. Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#profilers">10.4. Profilers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-introduction-to-gprof">10.5. An introduction to <code class="docutils literal notranslate"><span class="pre">gprof</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">10.5.1. Exercise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">10.5.2. Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-introduction-to-perf">10.6. An introduction to <code class="docutils literal notranslate"><span class="pre">perf</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-perf">10.6.1. Installing perf</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-perf">10.6.2. Using perf</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#flamegraphs">10.6.3. Flamegraphs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">10.6.4. Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#some-guis-for-perf">10.7. Some guis for perf</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#speedscope">10.7.1. Speedscope</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hotspot">10.7.1.1. Hotspot</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">10.7.2. Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#profiling-with-valgrind-cachegrind-and-callgrind">10.8. Profiling with valgrind: cachegrind and callgrind</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cache-checker-cachegrind">10.8.1. Cache checker : cachegrind</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#callgrind">10.8.2. Callgrind</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#google-performance-tools">10.9. Google Performance Tools</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">10.10. Exercises</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="profiling">
<h1><span class="section-number">10. </span>Profiling<a class="headerlink" href="#profiling" title="Link to this heading">#</a></h1>
<p>After debugging your code and writing several tests to avoid repeating
the same bug, you want to start optimizing it to make it fast (but
keeping it correct). To do this, you need to measure. You need to detect
functions which take most of the time. Optimizing a function that takes
only 5% of the time will give you only marginal benefits. Finding the
functions that take most of the time is called profiling , and there are
several tools ready to help you. In the following we will learn to use
these tools to detect the hotspots/bottlenecks in our codes. Please keep in mind tha <a class="reference external" href="https://computers-are-fast.github.io/">Computers are fast</a>, but your code might not be using all the resources in an efficient way.</p>
<section id="why-profile">
<h2><span class="section-number">10.1. </span>Why profile?<a class="headerlink" href="#why-profile" title="Link to this heading">#</a></h2>
<p>Profiling allows you to learn how the computation time was spent and how
the data flows in your program. This can be achieved by just printing
the time spent on each section using some internal timers, or, better,
by using a tool called “profiler” that shows you how time was spent in
your program and which functions called which other functions.</p>
<p>Using a profiler is something that comes very handy when you want to
verify that your program does what you want it to do, especially when it
is not easy to analyze (it may contain many functions or many calls to
different functions and so on).</p>
<p>Remember, WE ARE SCIENTISTS, so we want to profile code to optimize the
computation time taken by our program. The key idea then becomes finding
where (which function/subroutine) is the computation time spent and
attack it using optimization techniques (studied in a previous session
of this course.</p>
</section>
<section id="measuring-the-whole-running-time">
<h2><span class="section-number">10.2. </span>Measuring the whole running time<a class="headerlink" href="#measuring-the-whole-running-time" title="Link to this heading">#</a></h2>
<p>Take the following code as example (from <a class="github reference external" href="https://github.com/thehackerwithin/PyTrieste/tree/master/valgrind">thehackerwithin/PyTrieste</a>)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>

<span class="cm">/*</span>
<span class="cm">  Tests cache misses.</span>
<span class="cm">*/</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">option1</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">option2</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">option3</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">){</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: cacheTest sizeI sizeJ</span><span class="se">\n</span><span class="s">In first input.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">sI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">sJ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Operating on matrix of size %ld by %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sI</span><span class="p">,</span><span class="w"> </span><span class="n">sJ</span><span class="p">);</span>

<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">long</span><span class="p">[</span><span class="n">sI</span><span class="o">*</span><span class="n">sJ</span><span class="p">];</span><span class="w"> </span><span class="c1">// double array.</span>

<span class="w">  </span><span class="c1">// option 1</span>
<span class="w">  </span><span class="n">option1</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="n">sI</span><span class="p">,</span><span class="w"> </span><span class="n">sJ</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">  </span><span class="c1">// option 2</span>
<span class="w">  </span><span class="n">option2</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="n">sI</span><span class="p">,</span><span class="w"> </span><span class="n">sJ</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// option 3</span>
<span class="w">  </span><span class="n">option3</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="n">sI</span><span class="p">,</span><span class="w"> </span><span class="n">sJ</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// why this?</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="w">  </span><span class="c1">// free memory</span>
<span class="w">  </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">arr</span><span class="p">;</span><span class="w"> </span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">option1</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span>
<span class="w">      </span><span class="n">data</span><span class="p">[(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">option2</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span>
<span class="w">      </span><span class="n">data</span><span class="p">[(</span><span class="n">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">option3</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="o">*</span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Read it and try to understand what it does. Now, compile and run it.</p>
<p>If you want to measure the while running time against the matrix size, you can use the commands <code class="docutils literal notranslate"><span class="pre">time</span></code> or <code class="docutils literal notranslate"><span class="pre">/usr/bin/time</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>/usr/bin/time<span class="w"> </span>./a.out<span class="w"> </span><span class="m">4000</span><span class="w"> </span><span class="m">8000</span>
</pre></div>
</div>
<p>This will give you the total running clock time of the program. This is useful if the code is dominated by the computing part, not the memory allocation or similar things. Run it several times per size and observe the fluctuations.</p>
<p>But, if you need to measure a more specific part of your code, it is much better to measure those parts directly.</p>
</section>
<section id="measuring-elapsed-time">
<h2><span class="section-number">10.3. </span>Measuring elapsed time<a class="headerlink" href="#measuring-elapsed-time" title="Link to this heading">#</a></h2>
<p>The first approach is to just add timers to your code. This is a good
practice and it is useful for a code to report the time spent on
different parts.  We will use the previous example and add watches at specific points, using <code class="docutils literal notranslate"><span class="pre">std::chrono</span></code> (you can see
more examples <a class="reference external" href="https://www.techiedelight.com/measure-elapsed-time-program-chrono-library/">https://www.techiedelight.com/measure-elapsed-time-program-chrono-library/</a> and <a class="reference external" href="https://en.cppreference.com/w/cpp/chrono/duration">https://en.cppreference.com/w/cpp/chrono/duration</a>. This allows to measure the <strong>clock time</strong>, not the <strong>cpu time</strong> (look for the differences …) . Notice that <code class="docutils literal notranslate"><span class="pre">high_resolution_clock</span></code> is implementation defined, so it can be aliases to <code class="docutils literal notranslate"><span class="pre">system_clock</span></code>, which is not guaranteed to be steady. Beter use the <code class="docutils literal notranslate"><span class="pre">steady_clock</span></code>.</p>
<p>An example to use a timer is</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="n">option1</span><span class="p">(...);</span>
<span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// prints the time diff in arbitrary units</span>
</pre></div>
</div>
<section id="exercise">
<h3><span class="section-number">10.3.1. </span>Exercise<a class="headerlink" href="#exercise" title="Link to this heading">#</a></h3>
<p>Add timers for all the previous function calls, including the memory allocation and freed. <strong>Improve to print the actual time in seconds</strong>. Compare with the total time.  Compile and run it . Now you have much better results, the granularity has increased and now you know where the code is spending most of the time.  Analyze the results.</p>
</section>
<section id="id1">
<h3><span class="section-number">10.3.2. </span>Exercise<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>Plot the time average time per option as function of the matriz size (use square matrices of size nxn, plot againts n). Explain the differences in complexity.</p>
</section>
</section>
<section id="profilers">
<h2><span class="section-number">10.4. </span>Profilers<a class="headerlink" href="#profilers" title="Link to this heading">#</a></h2>
<p>There are many types of profilers from many different sources, commonly,
a profiler is associated to a compiler, so that for example, GNU (the
community around gcc compiler) has the profiler ‘gprof’, intel
(corporation behind icc) has iprof, PGI has pgprof, etc. Valgrind is
also a useful profiler through the cachegrind tool, which has been shown
at the debugging section. There is also a very famous and important profile in linux, perf, which can help to generate <a class="reference external" href="https://www.brendangregg.com/flamegraphs.html">flame graphs</a>.</p>
<p>This mini tutorial will focus on using gprof.
Note that gprof supports (to some extend) compiled code by other
compilers such as icc and pgcc. At the end we will briefly review perf,
and the google performance tools.</p>
<blockquote>
<div><p><strong>FACT 1:</strong> According to Thiel, “gprof … revolutionized the
performance analysis field and quickly became the tool of choice for
developers around the world …, the tool is still actively maintained
and remains relevant in the modern world.” (from Wikipedia).</p>
</div></blockquote>
<blockquote>
<div><p><strong>FACT 2:</strong> Top 50 most influential papers on PLDI (from Wikipedia).</p>
</div></blockquote>
<p>Here we will check some utilities like gprof, perf, and valgrind. But please notice that there are some other alternatives like</p>
<ul class="simple">
<li><p>tracy: https://github.com/wolfpld/tracy</p></li>
<li><p>Papi (Performance api), <a class="reference external" href="https://icl.utk.edu/papi/">https://icl.utk.edu/papi/</a></p></li>
<li><p>Perfetto, a solution provided by google: https://perfetto.dev/</p></li>
<li><p>memray, a python profiler : https://github.com/bloomberg/memray</p></li>
<li><p>The list is very large: <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_performance_analysis_tools?useskin=vector">https://en.wikipedia.org/wiki/List_of_performance_analysis_tools?useskin=vector</a></p></li>
</ul>
<p>In the following we will see some simple introductions to some of these tools.</p>
</section>
<section id="an-introduction-to-gprof">
<h2><span class="section-number">10.5. </span>An introduction to <code class="docutils literal notranslate"><span class="pre">gprof</span></code><a class="headerlink" href="#an-introduction-to-gprof" title="Link to this heading">#</a></h2>
<p>The gnu profiler, <a class="reference external" href="https://ftp.gnu.org/old-gnu/Manuals/gprof-2.9.1/html_mono/gprof.html">gprof</a>, works pretty well with the gnu tools and allows to you to get a peerformance profile for your programs. To do so, the general approach is to</p>
<ol class="arabic simple">
<li><p>Compile with the flag <code class="docutils literal notranslate"><span class="pre">-pg</span></code></p></li>
</ol>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-Wall<span class="w"> </span>-pg<span class="w"> </span>-g<span class="w"> </span>test_gprof.c<span class="w"> </span>-o<span class="w"> </span>test_gprof.x
</pre></div>
</div>
<ol class="arabic" start="2">
<li><p>Execute normally. This will create or overwrite the file <code class="docutils literal notranslate"><span class="pre">gmon.out</span></code></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./test_gprof.x
</pre></div>
</div>
</li>
<li><p>Process the report as</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gprof<span class="w"> </span>test_gprof.x<span class="w"> </span>gmon.out<span class="w"> </span>&gt;<span class="w"> </span>analysis.txt
</pre></div>
</div>
</li>
</ol>
<p>This produces a file called ‘analysis.txt’ which contains the profiling
information in a human-readable form. The output of this file is  like the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Flat<span class="w"> </span>profile:

Each<span class="w"> </span>sample<span class="w"> </span>counts<span class="w"> </span>as<span class="w"> </span><span class="m">0</span>.01<span class="w"> </span>seconds.
<span class="w">  </span>%<span class="w">   </span>cumulative<span class="w">   </span>self<span class="w">              </span>self<span class="w">     </span>total
<span class="w"> </span><span class="nb">time</span><span class="w">   </span>seconds<span class="w">   </span>seconds<span class="w">    </span>calls<span class="w">   </span>s/call<span class="w">   </span>s/call<span class="w">  </span>name
<span class="w"> </span><span class="m">39</span>.64<span class="w">      </span><span class="m">9</span>.43<span class="w">     </span><span class="m">9</span>.43<span class="w">        </span><span class="m">1</span><span class="w">     </span><span class="m">9</span>.43<span class="w">    </span><span class="m">16</span>.79<span class="w">  </span>func1
<span class="w"> </span><span class="m">30</span>.89<span class="w">     </span><span class="m">16</span>.79<span class="w">     </span><span class="m">7</span>.35<span class="w">        </span><span class="m">1</span><span class="w">     </span><span class="m">7</span>.35<span class="w">     </span><span class="m">7</span>.35<span class="w">  </span>new_func1
<span class="w"> </span><span class="m">30</span>.46<span class="w">     </span><span class="m">24</span>.04<span class="w">     </span><span class="m">7</span>.25<span class="w">        </span><span class="m">1</span><span class="w">     </span><span class="m">7</span>.25<span class="w">     </span><span class="m">7</span>.25<span class="w">  </span>func2
<span class="w">  </span><span class="m">0</span>.13<span class="w">     </span><span class="m">24</span>.07<span class="w">     </span><span class="m">0</span>.03<span class="w">                             </span>main

<span class="w"> </span>%<span class="w">         </span>the<span class="w"> </span>percentage<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>total<span class="w"> </span>running<span class="w"> </span><span class="nb">time</span><span class="w"> </span>of<span class="w"> </span>the
<span class="nb">time</span><span class="w">       </span>program<span class="w"> </span>used<span class="w"> </span>by<span class="w"> </span>this<span class="w"> </span><span class="k">function</span>.

...

<span class="w">             </span>Call<span class="w"> </span>graph<span class="w"> </span><span class="o">(</span>explanation<span class="w"> </span>follows<span class="o">)</span>


granularity:<span class="w"> </span>each<span class="w"> </span>sample<span class="w"> </span>hit<span class="w"> </span>covers<span class="w"> </span><span class="m">2</span><span class="w"> </span>byte<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">0</span>.04%<span class="w"> </span>of<span class="w"> </span><span class="m">24</span>.07<span class="w"> </span>seconds

index<span class="w"> </span>%<span class="w"> </span><span class="nb">time</span><span class="w">    </span>self<span class="w">  </span>children<span class="w">    </span>called<span class="w">     </span>name
<span class="w">                                                 </span>&lt;spontaneous&gt;
<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w">    </span><span class="m">100</span>.0<span class="w">    </span><span class="m">0</span>.03<span class="w">   </span><span class="m">24</span>.04<span class="w">                 </span>main<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span>
<span class="w">                </span><span class="m">9</span>.43<span class="w">    </span><span class="m">7</span>.35<span class="w">       </span><span class="m">1</span>/1<span class="w">           </span>func1<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span>
<span class="w">                </span><span class="m">7</span>.25<span class="w">    </span><span class="m">0</span>.00<span class="w">       </span><span class="m">1</span>/1<span class="w">           </span>func2<span class="w"> </span><span class="o">[</span><span class="m">4</span><span class="o">]</span>
-----------------------------------------------
<span class="w">                </span><span class="m">9</span>.43<span class="w">    </span><span class="m">7</span>.35<span class="w">       </span><span class="m">1</span>/1<span class="w">           </span>main<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span>
<span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w">     </span><span class="m">69</span>.7<span class="w">    </span><span class="m">9</span>.43<span class="w">    </span><span class="m">7</span>.35<span class="w">       </span><span class="m">1</span><span class="w">         </span>func1<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span>
<span class="w">                </span><span class="m">7</span>.35<span class="w">    </span><span class="m">0</span>.00<span class="w">       </span><span class="m">1</span>/1<span class="w">           </span>new_func1<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span>
-----------------------------------------------
<span class="w">                </span><span class="m">7</span>.35<span class="w">    </span><span class="m">0</span>.00<span class="w">       </span><span class="m">1</span>/1<span class="w">           </span>func1<span class="w"> </span><span class="o">[</span><span class="m">2</span><span class="o">]</span>
<span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w">     </span><span class="m">30</span>.5<span class="w">    </span><span class="m">7</span>.35<span class="w">    </span><span class="m">0</span>.00<span class="w">       </span><span class="m">1</span><span class="w">         </span>new_func1<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span>
-----------------------------------------------
<span class="w">                </span><span class="m">7</span>.25<span class="w">    </span><span class="m">0</span>.00<span class="w">       </span><span class="m">1</span>/1<span class="w">           </span>main<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span>
<span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w">     </span><span class="m">30</span>.1<span class="w">    </span><span class="m">7</span>.25<span class="w">    </span><span class="m">0</span>.00<span class="w">       </span><span class="m">1</span><span class="w">         </span>func2<span class="w"> </span><span class="o">[</span><span class="m">4</span><span class="o">]</span>
-----------------------------------------------

<span class="w"> </span>This<span class="w"> </span>table<span class="w"> </span>describes<span class="w"> </span>the<span class="w"> </span>call<span class="w"> </span>tree<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>program,<span class="w"> </span>and<span class="w"> </span>was<span class="w"> </span>sorted<span class="w"> </span>by
<span class="w"> </span>the<span class="w"> </span>total<span class="w"> </span>amount<span class="w"> </span>of<span class="w"> </span><span class="nb">time</span><span class="w"> </span>spent<span class="w"> </span><span class="k">in</span><span class="w"> </span>each<span class="w"> </span><span class="k">function</span><span class="w"> </span>and<span class="w"> </span>its<span class="w"> </span>children.

...
<span class="w"></span>
Index<span class="w"> </span>by<span class="w"> </span><span class="k">function</span><span class="w"> </span>name

<span class="w">   </span><span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span>func1<span class="w">                   </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span>main
<span class="w">   </span><span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w"> </span>func2<span class="w">                   </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span>new_func1
</pre></div>
</div>
<p>The output has two sections:</p>
<ul class="simple">
<li><p><em>Flat profile:</em> The flat profile shows the total amount of time your program spent executing each function.</p></li>
<li><p><em>Call graph:</em> The call graph shows how much time was spent in each function and its children.</p></li>
</ul>
<p>To create flamegraphs, you can try to setup a complicated script to transform the gprof output into something readable by the <a class="reference external" href="https://github.com/brendangregg/FlameGraph">flamegraphs</a> scripts, or better use perf.</p>
<section id="id2">
<h3><span class="section-number">10.5.1. </span>Exercise<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>Create the gprof analysis for the previous code. Where would you focus your efforts to optimize this program?</p>
</section>
<section id="id3">
<h3><span class="section-number">10.5.2. </span>Exercise<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>Create the gprof analysis for the following code. Where would you focus your efforts to optimize this program?</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">//test_gprof.c</span>
<span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">new_func1</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">func1</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">func2</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">new_func1</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Inside main()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="p">(;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0xffffff</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">);</span>
<span class="w">  </span><span class="n">func1</span><span class="p">();</span>
<span class="w">  </span><span class="n">func2</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">new_func1</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">func1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Inside func1 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="p">(;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0xffffffff</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">);</span>
<span class="w">  </span><span class="n">new_func1</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">func2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Inside func2 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="p">(;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0xffffffaa</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">new_func1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Inside new_func1()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="p">(;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0xffffffee</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
</section>
</section>
<section id="an-introduction-to-perf">
<h2><span class="section-number">10.6. </span>An introduction to <code class="docutils literal notranslate"><span class="pre">perf</span></code><a class="headerlink" href="#an-introduction-to-perf" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://perfwiki.github.io/main/">perf</a> is powerful: it can instrument CPU performance counters, tracepoints, kprobes, and uprobes (dynamic tracing). It is capable of lightweight profiling. It is also included in the Linux kernel, under tools/perf, and is frequently updated and enhanced. (from <a class="reference external" href="https://perf.wiki.kernel.org/index.php/Main_Page">https://perf.wiki.kernel.org/index.php/Main_Page</a>)</p>
<p>More about perf: https://www.brendangregg.com/perf.html , https://www.swift.org/documentation/server/guides/linux-perf.html</p>
<p>It can also ve used in other languages, like python https://docs.python.org/3/howto/perf_profiling.html</p>
<p>An example of fixing a program using perf: https://pkolaczk.github.io/server-slower-than-a-laptop/</p>
<section id="installing-perf">
<h3><span class="section-number">10.6.1. </span>Installing perf<a class="headerlink" href="#installing-perf" title="Link to this heading">#</a></h3>
<p>Perf is a kernel module, so you will need to install it from the kernel
source. As root, the command used to install perl in the computer room
was (this needs root privileges)</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/usr/src/linux/tools/perf/<span class="p">;</span><span class="w"> </span>make<span class="w"> </span>-j<span class="w"> </span><span class="k">$(</span>nproc<span class="k">)</span><span class="p">;</span><span class="w"> </span>cp<span class="w"> </span>perf<span class="w"> </span>/usr/local/bin
</pre></div>
</div>
<p>This will copy the perf executable into the path.</p>
</section>
<section id="using-perf">
<h3><span class="section-number">10.6.2. </span>Using perf<a class="headerlink" href="#using-perf" title="Link to this heading">#</a></h3>
<p>Perf is a hardware counter available on linux platforms. NOTE: It is recommended to compile with <code class="docutils literal notranslate"><span class="pre">-fno-omit-frame-pointer</span></code></p>
<p>Its use is very simple: Just run, For a profile summary,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>perf<span class="w"> </span>stat<span class="w"> </span>./a.out<span class="w"> </span>&gt;<span class="w"> </span>profile_summary
</pre></div>
</div>
<p>For gprof-like info, use</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">perf</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span>
<span class="n">perf</span><span class="w"> </span><span class="n">report</span>
</pre></div>
</div>
<p>This will generate something like</p>
<a class="reference internal image-reference" href="../_images/perf-report.png"><img alt="" class="align-center" src="../_images/perf-report.png" style="width: 70%;" /></a>
<p>There are several command options</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">stat</span></code>: obtain event counts</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">record</span></code>: record events for later reporting</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">report</span></code>: break down events by process, function, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">annotate</span></code>: annotate assembly or source code with event counts</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">top</span></code>: see live event count</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">bench</span></code>: run different kernel microbenchmarks</p></li>
<li></li>
</ul>
<p>Check <a class="reference external" href="https://perfwiki.github.io/main/tutorial/">https://perfwiki.github.io/main/tutorial/</a> for more.</p>
</section>
<section id="flamegraphs">
<h3><span class="section-number">10.6.3. </span>Flamegraphs<a class="headerlink" href="#flamegraphs" title="Link to this heading">#</a></h3>
<p>To generate a flamegraphs, you can use the scripts at <a class="github reference external" href="https://github.com/brendangregg/FlameGraph">brendangregg/FlameGraph</a>. Let’s assume that you have clone that repo inside the Downloads/ directory.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/Downloads/
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/brendangregg/FlameGraph
</pre></div>
</div>
<p>First you need tor run perf, like (perf arg <code class="docutils literal notranslate"><span class="pre">-a</span></code> requires kernel profile capability)</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>perf<span class="w"> </span>record<span class="w"> </span>--call-graph<span class="w"> </span>dwarf<span class="w">  </span>-F<span class="w"> </span><span class="m">99</span><span class="w"> </span>-g<span class="w"> </span>--<span class="w"> </span><span class="nb">command</span><span class="w"> </span>arg1<span class="w"> </span>arg2<span class="w"> </span>...
</pre></div>
</div>
<p>This command will generate a <code class="docutils literal notranslate"><span class="pre">perf.data</span></code> file in your current directory.</p>
<p>Then you need to transform the perf.data data into a human readable file</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>perf<span class="w"> </span>script<span class="w"> </span>&gt;<span class="w"> </span>out.perf
</pre></div>
</div>
<p>Now fold the stacks, to collapse identical calls</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/Downloads/FlameGraph/stackcollapse-perf.pl<span class="w"> </span>./out.perf<span class="w"> </span>&gt;<span class="w"> </span>out.folded
</pre></div>
</div>
<p>And, finally, generate the flamegraph</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/Downloads/FlameGraph/flamegraph.pl<span class="w"> </span>out.folded<span class="w"> </span>&gt;<span class="w"> </span>flamegraph.svg
</pre></div>
</div>
<p>Open it with firefox or inkscape. You will get something like</p>
<a class="reference internal image-reference" href="../_images/flamegraph-1.png"><img alt="" class="align-center" src="../_images/flamegraph-1.png" style="width: 90%;" /></a>
<p>As you can see, the width is proportional to the time.</p>
</section>
<section id="id4">
<h3><span class="section-number">10.6.4. </span>Exercise<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>Generate the flamegraph for the previous code</p>
</section>
</section>
<section id="some-guis-for-perf">
<h2><span class="section-number">10.7. </span>Some guis for perf<a class="headerlink" href="#some-guis-for-perf" title="Link to this heading">#</a></h2>
<section id="speedscope">
<h3><span class="section-number">10.7.1. </span>Speedscope<a class="headerlink" href="#speedscope" title="Link to this heading">#</a></h3>
<p>It can load the <code class="docutils literal notranslate"><span class="pre">perf.data</span></code> file and visualize it. Go to <a class="reference external" href="https://www.speedscope.app/">https://www.speedscope.app/</a> and load your perf data. You can also go to the repo and download a local installation to be able to run all locally. It will show you something like</p>
<p>Flamegraph:</p>
<a class="reference internal image-reference" href="../_images/speedscope-1.png"><img alt="" class="align-center" src="../_images/speedscope-1.png" style="width: 90%;" /></a>
<p>Callgraph:</p>
<a class="reference internal image-reference" href="../_images/speedscope-2.png"><img alt="" class="align-center" src="../_images/speedscope-2.png" style="width: 90%;" /></a>
<section id="hotspot">
<h4><span class="section-number">10.7.1.1. </span>Hotspot<a class="headerlink" href="#hotspot" title="Link to this heading">#</a></h4>
<p>Please see <a class="github reference external" href="https://github.com/KDAB/hotspot">KDAB/hotspot</a>  and <a class="reference external" href="https://www.kdab.com/hotspot-video/">https://www.kdab.com/hotspot-video/</a>.</p>
<p>Install with the appimage: Download it from the releases at <a class="github reference external" href="https://github.com/KDAB/hotspot">KDAB/hotspot</a>. Then,  make it executable</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chmod<span class="w"> </span>+x<span class="w"> </span>~/Downloads/hotspot-v1.5.1-x86_64.AppImage
</pre></div>
</div>
<p>And, finally, run it. If you run it from the same directoy with the perf data, it will automatically load it, giving you all the data in a uniform gui.</p>
<a class="reference internal image-reference" href="../_images/hotspot-1.png"><img alt="" class="align-center" src="../_images/hotspot-1.png" style="width: 70%;" /></a>
<a class="reference internal image-reference" href="../_images/hotspot-2.png"><img alt="" class="align-center" src="../_images/hotspot-2.png" style="width: 70%;" /></a>
<p>NOTE: In the computer room you can also use spack:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>spack<span class="w"> </span>load<span class="w"> </span>hotspot-perf
</pre></div>
</div>
<p>And then just use the command <code class="docutils literal notranslate"><span class="pre">hotspot</span></code> .</p>
</section>
</section>
<section id="id5">
<h3><span class="section-number">10.7.2. </span>Exercise<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<p>Create a flamegraph visualzation using both speedscope and hotspot.</p>
</section>
</section>
<section id="profiling-with-valgrind-cachegrind-and-callgrind">
<h2><span class="section-number">10.8. </span>Profiling with valgrind: cachegrind and callgrind<a class="headerlink" href="#profiling-with-valgrind-cachegrind-and-callgrind" title="Link to this heading">#</a></h2>
<p>Valgrind allows not only to debug a code but also to profile it. Here we
will see how to use cachegrind, to check for cache misses, and
callgrind, for a calling graph much like tools like perf and gprof.</p>
<section id="cache-checker-cachegrind">
<h3><span class="section-number">10.8.1. </span>Cache checker : cachegrind<a class="headerlink" href="#cache-checker-cachegrind" title="Link to this heading">#</a></h3>
<p>From <a class="reference external" href="http://valgrind.org/docs/manual/cg-manual.html#cg-manual.overview">cachegrind</a></p>
<blockquote>
<div><p>Cachegrind simulates how your program interacts with a machine’s
cache hierarchy and (optionally) branch predictor. It simulates a
machine with independent first-level instruction and data caches (I1
and D1), backed by a unified second-level cache (L2). This exactly
matches the configuration of many modern machines.</p>
</div></blockquote>
<blockquote>
<div><p>However, some modern machines have three levels of cache. For these
machines (in the cases where Cachegrind can auto-detect the cache
configuration) Cachegrind simulates the first-level and third-level
caches. The reason for this choice is that the L3 cache has the most
influence on runtime, as it masks accesses to main memory.
Furthermore, the L1 caches often have low associativity, so simulating
them can detect cases where the code interacts badly with this cache
(eg. traversing a matrix column-wise with the row length being a power
of 2).</p>
</div></blockquote>
<blockquote>
<div><p>Therefore, Cachegrind always refers to the I1, D1 and LL (last-level)
caches.</p>
</div></blockquote>
<p>To use cachegrind, you will need to invoke valgrind as</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>valgrind<span class="w"> </span>--tool<span class="o">=</span>cachegrind<span class="w"> </span>prog
</pre></div>
</div>
<p>Take into account that execution will be (possibly very) slow.</p>
<p>Typical output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>I<span class="w">   </span>refs:<span class="w">      </span><span class="m">27</span>,742,716
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>I1<span class="w">  </span>misses:<span class="w">           </span><span class="nv">276</span>
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>LLi<span class="w"> </span>misses:<span class="w">           </span><span class="nv">275</span>
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>I1<span class="w">  </span>miss<span class="w"> </span>rate:<span class="w">        </span><span class="m">0</span>.0%
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>LLi<span class="w"> </span>miss<span class="w"> </span>rate:<span class="w">        </span><span class="m">0</span>.0%
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span>
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>D<span class="w">   </span>refs:<span class="w">      </span><span class="m">15</span>,430,290<span class="w">  </span><span class="o">(</span><span class="m">10</span>,955,517<span class="w"> </span>rd<span class="w"> </span>+<span class="w"> </span><span class="m">4</span>,474,773<span class="w"> </span>wr<span class="o">)</span>
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>D1<span class="w">  </span>misses:<span class="w">        </span><span class="m">41</span>,185<span class="w">  </span><span class="o">(</span><span class="w">    </span><span class="m">21</span>,905<span class="w"> </span>rd<span class="w"> </span>+<span class="w">    </span><span class="m">19</span>,280<span class="w"> </span>wr<span class="o">)</span>
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>LLd<span class="w"> </span>misses:<span class="w">        </span><span class="m">23</span>,085<span class="w">  </span><span class="o">(</span><span class="w">     </span><span class="m">3</span>,987<span class="w"> </span>rd<span class="w"> </span>+<span class="w">    </span><span class="m">19</span>,098<span class="w"> </span>wr<span class="o">)</span>
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>D1<span class="w">  </span>miss<span class="w"> </span>rate:<span class="w">        </span><span class="m">0</span>.2%<span class="w"> </span><span class="o">(</span><span class="w">       </span><span class="m">0</span>.1%<span class="w">   </span>+<span class="w">       </span><span class="m">0</span>.4%<span class="o">)</span>
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>LLd<span class="w"> </span>miss<span class="w"> </span>rate:<span class="w">        </span><span class="m">0</span>.1%<span class="w"> </span><span class="o">(</span><span class="w">       </span><span class="m">0</span>.0%<span class="w">   </span>+<span class="w">       </span><span class="m">0</span>.4%<span class="o">)</span>
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span>
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>LL<span class="w"> </span>misses:<span class="w">         </span><span class="m">23</span>,360<span class="w">  </span><span class="o">(</span><span class="w">     </span><span class="m">4</span>,262<span class="w"> </span>rd<span class="w"> </span>+<span class="w">    </span><span class="m">19</span>,098<span class="w"> </span>wr<span class="o">)</span>
<span class="o">==</span><span class="nv">31751</span><span class="o">==</span><span class="w"> </span>LL<span class="w"> </span>miss<span class="w"> </span>rate:<span class="w">         </span><span class="m">0</span>.0%<span class="w"> </span><span class="o">(</span><span class="w">       </span><span class="m">0</span>.0%<span class="w">   </span>+<span class="w">       </span><span class="m">0</span>.4%<span class="o">)</span>
</pre></div>
</div>
<p>The output and more info will be written to <code class="docutils literal notranslate"><span class="pre">cachegrind.out.&lt;pid&gt;</span></code>,
where pid is the PID of the process. You can open that file with
valkyrie for better analysis.</p>
<p>The tool <code class="docutils literal notranslate"><span class="pre">cg_annonate</span></code> allows you postprocess better the file
<code class="docutils literal notranslate"><span class="pre">cachegrind.out.&lt;pid&gt;</span></code>.</p>
<p>Compile the file cacheTest.cc,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>g++<span class="w"> </span>-g<span class="w"> </span>cacheTest.cc<span class="w"> </span>-o<span class="w"> </span>cacheTest
</pre></div>
</div>
<p>Now run valgrind on it, with cache checker</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>valgrind<span class="w"> </span>--tool<span class="o">=</span>cachegrind<span class="w"> </span>./cacheTest<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="m">100000</span>
</pre></div>
</div>
<p>Now let’s check the cache-misses per line of source code:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cg_annotate<span class="w"> </span>--auto<span class="o">=</span>yes<span class="w"> </span>cachegrind.out.PID
</pre></div>
</div>
<p>where you have to change <code class="docutils literal notranslate"><span class="pre">PID</span></code> by the actual PID in your results.</p>
<p>Fix the code.</p>
<ol class="arabic">
<li><p>More cache examples</p>
<p>Please open the file <code class="docutils literal notranslate"><span class="pre">cache.cpp</span></code> which is inside the directory
valgrind. Read it. Comment the line</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>std::sort<span class="o">(</span>data,<span class="w"> </span>data<span class="w"> </span>+<span class="w"> </span>arraySize<span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
<p>Compile the program and run it, measuring the execution time (if you
wish, you can use optimization):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>g++<span class="w"> </span>-g<span class="w"> </span>cache.cpp<span class="w"> </span>-o<span class="w"> </span>cache.x
$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>./cache.x
</pre></div>
</div>
<p>The output will be something like</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">26</span>.6758
<span class="nv">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">312426300000</span>

real<span class="w">    </span>0m32.272s
user<span class="w">    </span>0m26.560s
sys<span class="w"> </span>0m0.122s
</pre></div>
</div>
<p>Now uncomment the same line, re-compile and re-run. You will get
something like</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">5</span>.37881
<span class="nv">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">312426300000</span>

real<span class="w">    </span>0m6.180s
user<span class="w">    </span>0m5.360s
sys<span class="w"> </span>0m0.026s
</pre></div>
</div>
<p>The difference is big. You can verify that this happens even with
compiler optimisations enabled. What it is going on here?</p>
<p>Try to figure out an explanation before continuing.</p>
<p>Now let’s use valgrind to track the problem. Run the code (with the
sort line commented) with cachegrind:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>valgrind<span class="w"> </span>--tool<span class="o">=</span>cachegrind<span class="w"> </span>./a.out
</pre></div>
</div>
<p>And now let’s annotate the code (remember to change PID for your
actual number):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cg_annonate<span class="w"> </span>--auto<span class="o">=</span>yes<span class="w"> </span>cachegrind.out.PID
</pre></div>
</div>
<p>We can see that we have something similar to <a class="reference external" href="http://goo.gl/gVwlj">stackoverflow
analysis</a></p>
<p>Understand why.</p>
</li>
</ol>
</section>
<section id="callgrind">
<h3><span class="section-number">10.8.2. </span>Callgrind<a class="headerlink" href="#callgrind" title="Link to this heading">#</a></h3>
<p>Now, we are using valgrind to get a calling profile by using the tool
<code class="docutils literal notranslate"><span class="pre">callgrind</span></code>. It is done as follows: Use the same program as in other
modules. First, compile with debugging enabled, something like</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-g<span class="w"> </span>-ggdb<span class="w"> </span>name.c<span class="w"> </span>-o<span class="w"> </span>name.x<span class="w"> </span>
</pre></div>
</div>
<p>and now execute with valgrind as</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>valgrind<span class="w"> </span>--tool<span class="o">=</span>callgrind<span class="w"> </span>name.x<span class="w"> </span><span class="o">[</span>possible<span class="w"> </span>options<span class="o">]</span>
</pre></div>
</div>
<p>Results will be stored on the files <code class="docutils literal notranslate"><span class="pre">callgrind.out.PID</span></code>, where <code class="docutils literal notranslate"><span class="pre">PID</span></code> is
the process identifier.</p>
<p>You can read the previous file with a text editor, by using the
instructions</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>callgrind_annotate<span class="w"> </span>--auto<span class="o">=</span>yes<span class="w"> </span>callgrind.out.PID
</pre></div>
</div>
<p>and you can also use the tool KCachegrind,</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kcachegrind<span class="w"> </span>callgrind.out.PID
</pre></div>
</div>
<p>(<strong>do not forget to replace PID by the actual number</strong>). The first view
presents the list of the profiled functions. If you click on a function,
other views appear with more info, as callers, calling map, source code,
etc.</p>
<p><em>NOTE</em>: If you want to see correct function names, you can use the
command</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>valgrind<span class="w"> </span>--tool<span class="o">=</span>callgrind<span class="w"> </span>--dump-instr<span class="o">=</span>yes<span class="w"> </span>--collect-jumps<span class="o">=</span>yes<span class="w"> </span>./program<span class="w"> </span>program_parameters
</pre></div>
</div>
<p>Please run and use callgrind to study the previous programs and also a
program using eigen library. In the later, it is easy to profile?</p>
<p>This is a typical output from the kcachegrind page:</p>
<a class="reference internal image-reference" href="https://kcachegrind.github.io/images/KcgShot3Large.gif"><img alt="https://kcachegrind.github.io/images/KcgShot3Large.gif" src="https://kcachegrind.github.io/images/KcgShot3Large.gif" style="width: 60%;" /></a>
</section>
</section>
<section id="google-performance-tools">
<h2><span class="section-number">10.9. </span>Google Performance Tools<a class="headerlink" href="#google-performance-tools" title="Link to this heading">#</a></h2>
<p>See <a class="github reference external" href="https://github.com/gperftools/gperftools">gperftools/gperftools</a></p>
<p>From <a class="reference external" href="http://code.google.com/p/gperftools/?redir=1">Google performance
tools</a> : These tools are
for use by developers so that they can create more robust applications.
Especially of use to those developing multi-threaded applications in C++
with templates. Includes TCMalloc, heap-checker, heap-profiler and
cpu-profiler.</p>
<p>In brief:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>TC<span class="w"> </span>Malloc:

gcc<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>-ltcmalloc
Heap<span class="w"> </span>Checker:

gcc<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>-o<span class="w"> </span>myprogram<span class="w"> </span>-ltcmalloc
<span class="nv">HEAPCHECK</span><span class="o">=</span>normal<span class="w"> </span>./myprogram
Heap<span class="w"> </span>Profiler:

gcc<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>-o<span class="w"> </span>myprogram<span class="w"> </span>-ltcmalloc
<span class="nv">HEAPPROFILE</span><span class="o">=</span>/tmp/netheap<span class="w"> </span>./myprogram
Cpu<span class="w"> </span>Profiler:

gcc<span class="w"> </span><span class="o">[</span>...<span class="o">]</span><span class="w"> </span>-o<span class="w"> </span>myprogram<span class="w"> </span>-lprofiler
<span class="nv">CPUPROFILE</span><span class="o">=</span>/tmp/profile<span class="w"> </span>./myprogram
</pre></div>
</div>
<p>Basically, when ypu compile, you link with the required library. Then,
you can generate a callgraph with profiler info. Try to install the
google performance tool on your home and test them with the previous
codes. Please review the detailed info for each tool: for example, for
the cpu profiler, check <a class="reference external" href="http://google-perftools.googlecode.com/svn/trunk/doc/cpuprofile.html">Cpu profiler
info</a></p>
</section>
<section id="exercises">
<h2><span class="section-number">10.10. </span>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Take <a class="reference external" href="https://bitbucket.org/iluvatar/scientific-computing-part-01/raw/9e1e2822cf7a6012b56708294eda1a5d3e0553b1/optimization/cache_lines.c">this
code</a>
and modify it (separate its behaviour into functions) to be able to
profile it.</p></li>
<li><p>Download
<a class="reference external" href="https://bitbucket.org/iluvatar/scientific-computing-part-01/downloads/CodigosIvan.zip">https://bitbucket.org/iluvatar/scientific-computing-part-01/downloads/CodigosIvan.zip</a>,
run , and optimize them.</p></li>
<li><p>Experiment: Take <a class="reference external" href="https://www.dropbox.com/s/qpphj2vzizzr7cl/oscilador.cpp">this
code</a>,
profile it and try to optimize it in any way.</p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./10-profiling"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../10-optimization/10-optimization.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">9. </span>Optimization</p>
      </div>
    </a>
    <a class="right-next"
       href="../11-matrices-numericallibs/11-matrices-numericallibs.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">11. </span>Numerical libraries in Matrix Problems</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-profile">10.1. Why profile?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measuring-the-whole-running-time">10.2. Measuring the whole running time</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measuring-elapsed-time">10.3. Measuring elapsed time</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">10.3.1. Exercise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">10.3.2. Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#profilers">10.4. Profilers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-introduction-to-gprof">10.5. An introduction to <code class="docutils literal notranslate"><span class="pre">gprof</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">10.5.1. Exercise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">10.5.2. Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-introduction-to-perf">10.6. An introduction to <code class="docutils literal notranslate"><span class="pre">perf</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-perf">10.6.1. Installing perf</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-perf">10.6.2. Using perf</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#flamegraphs">10.6.3. Flamegraphs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">10.6.4. Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#some-guis-for-perf">10.7. Some guis for perf</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#speedscope">10.7.1. Speedscope</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hotspot">10.7.1.1. Hotspot</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">10.7.2. Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#profiling-with-valgrind-cachegrind-and-callgrind">10.8. Profiling with valgrind: cachegrind and callgrind</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cache-checker-cachegrind">10.8.1. Cache checker : cachegrind</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#callgrind">10.8.2. Callgrind</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#google-performance-tools">10.9. Google Performance Tools</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">10.10. Exercises</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By William Oquendo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>